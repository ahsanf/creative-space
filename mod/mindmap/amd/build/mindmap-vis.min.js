define(["jquery","mod_mindmap/mindmap"],function(a,b){return{Init:function(c,d,e,f,g){function h(){document.getElementById("savebutton").onclick=null,document.getElementById("cancelbutton").onclick=null,document.getElementById("network-popup").style.display="none"}function i(a){h(),a(null)}function j(a,b){a.id=document.getElementById("node-id").value,a.label=document.getElementById("node-label").value,a.shape=document.getElementById("node-shape").value,a.font.color=document.getElementById("node-font-color").value,a.color.background=document.getElementById("node-color-background").value,h(),b(a)}function k(a){var b=[];return a.forEach(function(a,c,d){b.push({id:a.id,label:a.label,shape:a.hasOwnProperty("shape")?a.shape:"box",x:a.x,y:a.y,font:{color:a.hasOwnProperty("font")?a.font.color:"#343434"},color:{background:a.hasOwnProperty("color")?a.color.background:"#97c1fc"},widthConstraint:{maximum:300},margin:10})}),new vis.DataSet(b)}function l(a,b){for(var c=0;c<a.length;c++)if(a[c].id==b)return a[c];throw"Can not find id '"+b+"' in data"}function m(a){var b=[];return a.forEach(function(c){c.connections.forEach(function(d,e,f){b.push({from:c.id,to:d,width:2});var g=l(a,d),h=g.connections,i=h.filter(function(a){return a==c.id})[0];i!=-1&&h.splice(i,1)})}),new vis.DataSet(b)}function n(a){return Object.keys(a).map(function(b){return a[b].id=b,a[b]})}function o(a,b){a.connections=w.getConnectedNodes(a.id)}function p(a,b){a.label=w.body.nodes[a.id].options.label,w.body.nodes[a.id].options.hasOwnProperty("shape")&&(a.shape=w.body.nodes[a.id].options.shape),w.body.nodes[a.id].options.font.hasOwnProperty("color")&&(a.font={},a.font.color=w.body.nodes[a.id].options.font.color),w.body.nodes[a.id].options.color.hasOwnProperty("background")&&(a.color={},a.color.background=w.body.nodes[a.id].options.color.background)}function q(){var a=n(w.getPositions());a.forEach(p),a.forEach(o);var d=JSON.stringify(a,void 0,2),e=new b;e.mindmapsubmit(c,d)}var r;a.ajax({async:!1,url:"mindmapdata.php?id="+c+"&convert="+e,success:function(a){r=a}});var s=["en","de","es","it","fr","cz","nl","ru","cn","ua"],t={custom:{edit:g.visjsedit,del:g.visjsdel,back:g.visjsback,addNode:g.visjsaddnode,addEdge:g.visjsaddedge,editNode:g.visjseditnode,editEdge:g.visjseditedge,addDescription:g.visjsadddescription,edgeDescription:g.visjsedgedescription,editEdgeDescription:g.visjseditedgedescription,createEdgeError:g.visjscreateedgeerror,deleteClusterError:g.visjsdeleteclustererror,editClusterError:g.visjseditclustererror}},u=[{id:"moodle",label:"Moodle",x:400,y:370,font:{color:"#ffffff",size:18},color:{background:"#ff0000"},widthConstraint:{maximum:300},margin:10,borderWidth:1,shape:"box",labelHighlightBold:!1}],v=[],w=null,x=r;if(x.length>0)var y=JSON.parse(x),z={nodes:k(y),edges:m(y)};else var z={nodes:u,edges:v};var A=document.querySelector(".network"),B={};0==d?(B={manipulation:{initiallyActive:!0,addNode:function(a,b){document.getElementById("operation").innerHTML=g.visjsaddnode,document.getElementById("node-id").value=a.id,document.getElementById("node-label").value="",document.getElementById("node-font-color").value="#343434",document.getElementById("node-color-background").value="#97c1fc",document.getElementById("node-shape").value="box";var c={id:document.getElementById("node-id").value,x:a.x,y:a.y,label:document.getElementById("node-label").value,shape:document.getElementById("node-shape").value,font:{color:document.getElementById("node-font-color").value},color:{background:document.getElementById("node-color-background").value}};document.getElementById("savebutton").onclick=j.bind(this,c,b),document.getElementById("cancelbutton").onclick=h.bind(),document.getElementById("network-popup").style.display="block"},editNode:function(a,b){document.getElementById("operation").innerHTML=g.visjseditnode,document.getElementById("node-id").value=a.id,document.getElementById("node-label").value=a.label,document.getElementById("node-font-color").value=a.font.hasOwnProperty("color")?a.font.color:"#343434",document.getElementById("node-color-background").value=a.color.hasOwnProperty("background")?a.color.background:"#97c1fc",document.getElementById("node-shape").value=a.hasOwnProperty("shape")?a.shape:"box",document.getElementById("savebutton").onclick=j.bind(this,a,b),document.getElementById("cancelbutton").onclick=i.bind(this,b),document.getElementById("network-popup").style.display="block"},addEdge:function(a,b){if(a.from==a.to){var c=confirm("Do you want to connect the node to itself?");1==c&&b(a)}else b(a)}},physics:{enabled:!1},edges:{physics:!1,dashes:!1,smooth:{enabled:!1},width:2},nodes:{borderWidth:1,shape:"box",widthConstraint:{maximum:300},margin:10,font:{size:18},labelHighlightBold:!1}},a("#export_button").on("click",function(){q()})):(B={physics:{enabled:!1},edges:{physics:!1,dashes:!1,smooth:{enabled:!1},width:2},nodes:{borderWidth:1,shape:"box",widthConstraint:{maximum:300},margin:10,font:{size:18},labelHighlightBold:!1}},1==e&&a("#export_button").on("click",function(){q()})),a.inArray(f,s)!=-1?B.locale=f:(B.locales=t,B.locale="custom"),w=new vis.Network(A,z,B),w.on("zoom",function(){pos=[],pos=w.getViewPosition(),w.getScale()<=.49&&w.moveTo({position:{x:pos.x,y:pos.y},scale:.49}),w.getScale()>=5.49&&w.moveTo({position:{x:pos.x,y:pos.y},scale:5.49})}),a(".resetzoom").on("click",function(){w.fit()}),0==d&&(w.on("doubleClick",function(a){a.edges.length>=0&&a.nodes.length>0?w.editNode():a.edges.length>0&&0==a.nodes.length?w.editEdgeMode():0==a.edges.length&&0==a.nodes.length&&w.addEdgeMode()}),a("html").keyup(function(a){"Insert"==a.key&&w.addNodeMode(),"Delete"==a.key&&w.deleteSelected()}))}}});